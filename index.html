<!DOCTYPE html>
<html>
  <head>
    <title>Google Maps JavaScript API v3 Example: Map Coordinates</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link href="https://google-developers.appspot.com/maps/documentation/javascript/examples/default.css" rel="stylesheet">
    <style>
      #map_canvas {
        position: absolute;
        top: 100px;
        right: 40px;
        width: 400px;
        height: 300px;
      }
    </style>

    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=geometry"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script>
      var map;
      var paris_center = new google.maps.LatLng(48.849607,2.369799);
      var paris_bounds = new google.maps.LatLngBounds(
                            new google.maps.LatLng(48.6826472764688,2.13424956576032),
                            new google.maps.LatLng(49.0160829026163,2.60692165753642));

      var geoids = [];

      var circles = [];

      var singleton_infowindow;

      var LOWER_CUTOFF = 100;
      var UPPER_CUTOFF = 300;

      var marker_s = new google.maps.MarkerImage("marker.png", new google.maps.Size(17,17), new google.maps.Point(0,0), new google.maps.Point(8.5,8.5), new google.maps.Size(17,17));
      var marker_m = new google.maps.MarkerImage("marker.png", new google.maps.Size(34,34), new google.maps.Point(0,0), new google.maps.Point(17,17));
      var marker_l = new google.maps.MarkerImage("marker.png", new google.maps.Size(68,68), new google.maps.Point(0,0), new google.maps.Point(34,34), new google.maps.Size(68,68));

      function initialize() {
        var mapOptions = {
          zoom: 10,
          center: paris_center,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };

        map = new google.maps.Map(document.getElementById('map_canvas'),
            mapOptions);
        map.fitBounds(paris_bounds);

        google.maps.event.addListener(map, 'zoom_changed', function() {
          console.log("zoom", map.getZoom());
          draw_geoids();
        });

        // fetch geoids
        $.ajax("data/all_geoids_in_paris.json").done(function(data) {
          geoids = data;
          prev_scale = -1; // force draw
          draw_geoids();
        });
      }

      function display_radius() {
        var bounds = map.getBounds() ? map.getBounds() : paris_bounds;
        return google.maps.geometry.spherical.computeDistanceBetween (bounds.getNorthEast(), bounds.getSouthWest())/2;
      }

      function meters_per_pixel() {
        var pixel_radius = Math.sqrt(Math.pow($("#map_canvas").width(), 2) + Math.pow($("#map_canvas").height(), 2))/2;
        var mpp = display_radius() / pixel_radius;
        //console.log(pixel_radius, display_radius(), mpp);
        return mpp;
      }

      function clear_circles() {
        $(circles).each(function(i,c) {
          c.setMap(null);
        });
        circles = [];
      }

      function draw_geoids() {
        var mpp = meters_per_pixel();
        var min_geoid_size_m = LOWER_CUTOFF*mpp;
        var max_geoid_size_m = UPPER_CUTOFF*mpp;
        var minkm = min_geoid_size_m / 1000;
        var maxkm = max_geoid_size_m / 1000;
        console.log("map range radius", display_radius());
        console.log("showing only geoids of size", min_geoid_size_m);

        clear_circles();

        $(geoids).each(function(i,e) {
          if(e.radius >= minkm && e.radius <= maxkm) {

            e["bounds"] = new google.maps.LatLngBounds(
                              new google.maps.LatLng(e.min_lat, e.min_long),
                              new google.maps.LatLng(e.max_lat, e.max_long));

            /*
            var c = new google.maps.Circle({
              center: new google.maps.LatLng(e.lat, e.long),
              radius: e.radius*300,
              strokeColor: "white",
              fillColor: "#48B6E7",
              strokeWeight: 2,
              strokeOpacity: 1,
              fillOpacity: 1,
              map: map
            });
            */

            var msize = e.radius * 300 / mpp;
            marker_image = msize > 68 ? marker_l : (msize < 20 ? marker_s : marker_m)
            var m = new google.maps.Marker({
              position: new google.maps.LatLng(e.lat, e.long),
              fillColor: "#48B6E7",
              strokeWeight: 2,
              strokeOpacity: 1,
              fillOpacity: 1,
              flat: true,
              title: e.title +" ("+e.num_results+")",
              icon: marker_image,
              visible: true,
              map: map
            });

            /*
            var c = new google.maps.Rectangle({
              bounds: e.bounds,
              strokeColor: "#3333ff",
              fillColor: "#3333ff",
              strokeWeight: 1,
              strokeOpacity: 1,
              fillOpacity: 0.2,
              map: map
            });
            */

            circles.push(m);

            /*
            google.maps.event.addListener(c, 'mouseout', function() {
              if(singleton_infowindow) {
                singleton_infowindow.close();
              }
            });

            google.maps.event.addListener(c, 'mouseover', function() {
              console.log(e.title +" ("+e.num_results+")");
            });

            google.maps.event.addListener(c, 'click', function() {
              console.log(c);
              map.fitBounds(e.bounds);
            });
            */

          }
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div id="map_canvas"></div>
  </body>
</html>
